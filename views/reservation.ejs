<% include ./sub/header %>
      <% include ./rsv_section/menu %>
      <% include ./rsv_section/left_info %>

      <template v-if="menu_step=='room'">
        <% include ./rsv_section/room %>
      </template>
      <template v-else-if="menu_step=='date'">
        <custom-datepicker
          :inline="true"
          :default_date="new Date()"
          :building_id="params.building_id"
          :room_id="formData.room_id"
          :min_date="info.min_date"
          :on-selected="onSelected"
          maximum-view="day"
        ></custom-datepicker>
      </template>
      <template v-else-if="menu_step=='time'">
        <% include ./rsv_section/time %>
      </template>
      <template v-else>
        <% include ./rsv_section/detail %>
      </template>

    </main>
    
    <footer>
      <% include ./sub/footer %>
    </footer>
  </div>

<% include ./component/datepicker %>
  <script>
    var global = makeGlobal();
    var app = new Vue({
      el: '#app',
      data: function () {
        return {
          header_menu_name: global.getHeaderMenuName("<%-pagename %>"),
          is_user: <%- is_user %>,
          is_admin: <%- is_admin %>,
          query : <%-JSON.stringify(query) %>,
          params : <%-JSON.stringify(params) %>,
          date: null,
          method : '<%- method %>',
          menu_step : null,
          menu_step_info : {
            'room' : '강의실 선택',
            'date' : '날짜 선택',
            'time' : '시간 선택',
            'detail' : '상세정보 입력',
            'last' : '내용 확인',
          },
          menu_steps : {
            'R' : ['room', 'date', 'time', 'detail', 'last'],
            'DT' : ['date', 'time', 'room' ,'detail', 'last'],
          },
          
          info : {
            min_date: new Date(),
            floor : null,
            room_name : null,
            room_number : null,
            date: null,
            tiem_block_type: 'blank',
            time_array: [],
          },
          formData:{
            room_id:null,
            date:null,
            time_id_array:[],
          },

          rooms: {},
          holiday_results : [],
          study_group_results: [],
          department_results: [],
        }
      },
      methods: {
        chageMenuStep: function (menu_step) {
          var _obj = this.checkMenuStep(menu_step);
          var is_next = _obj.is_next;
          if (is_next) {
            alert('다음 단계를 선택할 수 없습니다')
          } else {
            this.menu_step = menu_step;
          }
        },
        checkMenuStep: function(menu_step) {
          var menu_step_array = this.menu_steps[this.method];
          var is_find = false;
          var is_next = false;
          var is_now = false;
          if (this.menu_step == menu_step) {
            is_now = true;
          } else {
            for (var i = 0; i < menu_step_array.length; i ++) {
              if (this.menu_step == menu_step_array[i]) {
                is_find = true;
              }
              if (menu_step == menu_step_array[i] && is_find) {
                is_next = true
              }
            }
          }
          return {
            is_next : is_next,
            is_now : is_now,
          };
        },
        menuClass: function (menu_step) {
          var _obj = this.checkMenuStep(menu_step);
          return {
            'btn btn-primary': _obj.is_now,
            'btn btn-default': !_obj.is_next,
            'btn btn-default disabled': _obj.is_next,
          }
        },
        chageMethod: function(method) {
          if (method == 'R') {
            this.menu_step = 'room';
          } else {
            this.menu_step = 'date';
          }
          this.method = method;
        },
        nextMenuStep: function() {
          var now_menu_step = this.menu_step;
          var menu_step_array = this.menu_steps[this.method];
          for (var i = 0; i < menu_step_array.length; i ++ ) {
            if(now_menu_step == menu_step_array[i] && i != menu_step_array.length - 1) {
              this.menu_step = menu_step_array[parseInt(i) + 1];
            }
          }
        },
        prevMenuStep: function() {
          var now_menu_step = this.menu_step;
          var menu_step_array = this.menu_steps[this.method];
          for (var i = 0; i < menu_step_array.length; i ++ ) {
            if (now_menu_step == menu_step_array[i]  && i != 0) {
              this.menu_step = menu_step_array[parseInt(i) - 1];
            }
          }
        },
        // ROOM
        changeRoomFloor: function(floor) {
          this.info.floor = (this.info.floor == floor) ? null : floor;
        },
        chooseRoom: function(room) {
          if (room.available_for_rsv_create != true) {
            var message = '예약 불가능 상태입니다.'
            if (!this.user) {
              message += '\n로그인 후 다시 확인해주세요.' 
            } else {
              message +=  '\n관리자로 로그인 해 주세요'
            } 

            alert(message);
          } else {
            var min_date = global.resetTime(new Date());
            min_date.setDate(min_date.getDate() + room.rsv_apply_min_day);
            this.info.min_date = min_date;

            this.info.room_number = room.room_number;
            this.info.room_name =  room.name;
            this.formData.room_id = room.room_id;
            this.nextMenuStep();
          }
        },
        getRoom: function() {
          var __this = this;
          global.ajax({
            url: '/api/room',
            type: 'GET',
            data: null,
            query: {
              building_id : this.params.building_id,
              sort_by_floor: 1,
            }
          },
          function(data, status) {
            __this.setRooms(data.results);
          },
          function(message, status, data) {
            alert(message);
          })
        },
        setRooms: function(data) {
          this.rooms = data;
        },
        // DATE
        onSelected: function(date) {
          this.formData.date = date;
          this.info.date = global.parseDate(date);
          this.nextMenuStep();
        },
        // TIME
        getAvailableTime: function() {
          var __this = this;
          global.ajax({
            url: '/api/available_time',
            type: 'GET',
            data: null,
            query: {
              building_id : this.params.building_id,
              room_id : this.formData.room_id,
              day_of_the_week : this.formData.date.getDay(),
            }
          },
          function(data, status) {
            var results = data.results;

            if (!data.is_active) {
              __this.prevMenuStep();
              alert('예약 가능한 시간이 없습니다.')
            } else {
              __this.setAvailableTimeResults(results);
            }
          },
          function(message, status, data) {
            alert(message);
          })
        },
        setAvailableTimeResults: function (data) {
          this.info.time_array = data;
        },
        getTimeArrayIndex: function(available_time_id) {
          var time_array = this.info.time_array;
          for (var i = 0; i < time_array.length; i++) {
            if (time_array[i].available_time_id == available_time_id) {
              return i
            }
          }
        },
        resetTimeBlockSelected: function() {
          var time_array =  this.info.time_array;
          for (var i = 0; i < time_array.length; i++) {
            time_array[i].is_seleted = 0;
          }
          this.info.start_time = null;
          this.info.end_time = null;
        },
        clickTimeBlock: function(_time) {
          var time_array = this.info.time_array;
          var _available_time_id = _time.available_time_id;

          var find_on_first = false;
          var reset_flag = false;
          
          for (var i = 0; i < time_array.length; i++) {
            var is_find = time_array[i].available_time_id == _available_time_id;
            if (this.info.tiem_block_type == 'blank') {
              if (is_find) {
                time_array[i].is_seleted = 1;
                this.info.tiem_block_type = 'fisrt';
                this.info.start_time = time_array[i];
                break;
              }
            } else  {
              if (is_find && (!find_on_first || time_array[i].is_seleted == 1)) {
                reset_flag = true;
                break;
              } 
              if (time_array[i].is_seleted == 1) {
                find_on_first = true;
              }

              if (find_on_first) {
                time_array[i].is_seleted = 1;
                if (is_find) {
                  this.info.end_time = time_array[i];
                  this.info.tiem_block_type = 'second';
                  break;
                }
              }
            }
          }
          
          if (reset_flag) {
            this.info.tiem_block_type = 'blank'
            this.resetTimeBlockSelected();
          }

        },
        timeBlockClass: function (_time) {
          if (!_time.is_seleted) {
            var start_time = this.info.start_time;
            var end_time = this.info.end_time;
            return 'btn btn-default'
          } else {
            return 'btn btn-primary'
          }
        },
        // DETAIL
        setDepartment: function(results,department_id) {
          this.department_results = results;
          this.formData.department_id = department_id;
        },
        setStudyGroupResults: function(data) {
          this.study_group_results = data;
        },
        getDepartment: function() {
          var __this = this;
          global.ajax({
            url: '/api/departemnt',
            type: 'GET',
            data: null,
          },
          function(data, status) {
            __this.setDepartment(data.results, data.department_id);
          },
          function(message, status, data) {
            alert(message);
          })
        },
        getStudyGroup: function() {
          var __this = this;
          global.ajax({
            url: '/api/study_group',
            type: 'GET',
            data: null,
            query: {
              building_id: this.params.building_id,
              is_join: 1,
            }
          },
          function(data, status) {
            var results = data.results;
            __this.setStudyGroupResults(results);
          },
          function(message, status, data) {
            alert(message);
          })
        },

        // DETAIL & Lar
        detailSubmit: function(e) {
          e.preventDefault();
          if (this.menu_step == 'detail') {
            this.nextMenuStep();
          } else {
            var time_array = this.info.time_array;
            for (var i = 0; i < time_array.length; i ++) {
              if (time_array[i].is_seleted == 1) {
                this.formData.time_id_array.push(time_array[i].available_time_id)
              }
            }
            global.ajax({
              url: '/api/room_rsv',
              type: 'POST',
              data: this.formData,
            },
            function(data, status) {
              var results = data.results;
              __this.setStudyGroupResults(results);
            },
            function(message, status, data) {
              alert(message);
            })
          }
        },
        
        // =====================
        resetRoom: function() {
          this.info.floor = null;
          this.info.room_name = null;
          this.info.room_number = null;
          this.formData.room_id = null;
        },
        resetDate: function() {
          this.formData.date = null;
          this.info.date = null;
          this.info.min_date = new Date();
        },
        resetTime: function() {
          this.info.time_array = null;
          this.info.start_time = null;
          this.info.end_time = null;
        },
        resetDetail: function() {
          this.formData.department_id = null;
          this.formData.study_group_id = null;
          this.formData.student_count = null;
          this.formData.non_student_count = null;
          this.formData.representative_name = null;
          this.formData.representative_phone = null;
          this.formData.description = null;
        },
      },
      watch: {
        menu_step: function (menu_step) {
          switch (menu_step) {
            case 'room':
              this.resetRoom();
              this.resetDate();
              this.resetTime();

              this.getRoom();
              break;
            case 'date':
              this.resetDate();
              this.resetTime();
              break;
            case 'time':
              this.resetTime();
              this.resetDetail();

              this.getAvailableTime();
              break;
            case 'detail':
              this.resetDetail();

              this.getDepartment();
              this.getStudyGroup();
              break;
          }
        },
      },
      created: function() {
        this.menu_step = this.menu_steps[this.method][0];
      }
    })
  </script>

</body>

</html>