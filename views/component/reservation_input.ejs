<script type="text/x-template" id="input-template">
  <form class="form-lnline" v-on:submit="onSubmitForm">

    <label class="col-sm-2 control-label">상태</label>
    <div v-if="mod!='POST'" class="col-sm-10">
      <p class="form-control-static">
        <label :class="classRsvStatus(reservation.rsv_status)">{{ reservation.rsv_status_name }}</label>
      </p>
    </div>
    <select v-else class="form-control" v-model="reservation.rsv_status">
      <option v-for="(status, i) in rsv_status_results" v-bind:value="status.rsv_status"
        :selected="reservation.rsv_status == status.rsv_status" :key="i">
        {{ status.name }}
      </option>
    </select>

    <label class="col-sm-2 control-label">카테고리</label>
    <div v-if="mod=='GET'" class="col-sm-10">
      <p class="form-control-static">{{ reservation.room_rsv_category_name }}</p>
    </div>
    <select v-else class="form-control" v-model="reservation.room_rsv_category_id">
      <option v-for="(room_rsv_category, i) in room_rsv_category_results" v-bind:value="room_rsv_category.room_rsv_category_id" :key="i">
        {{ room_rsv_category.name }}
      </option>
    </select>
    

    <label class="col-sm-2 control-label">제목</label>
    <div>
      <input type="text" class="form-control" v-model="reservation.title" :disabled="mod == 'GET'">
    </div>
    
    <div class="form-group" v-if="mod!='POST'">
      <label class="col-sm-2 control-label">날짜</label>
      <div class="col-sm-10">
        <p class="form-control-static">{{reservation.rsv_date}}</p>
      </div>
    </div>
    <div class="form-group">
      <label class="col-sm-2 control-label">타임블럭</label>
      <div v-for="(room_rsv_time, i) in room_rsv_time_list" >
        <button
        class="btn btn-default"
        v-bind:value="room_rsv_time.room_rsv_time_id" 
        :key="i"
        disabled
        >{{room_rsv_time.start_time}} ~ {{room_rsv_time.end_time}}</button>
        <button 
        type="button" 
        class="btn btn-danger" 
        @click="deleteRsvTime(i)"
        v-if="mod!='GET'"
        >-</button>
      </div>
      <template v-if="mod!='GET'">
        <custom-timepicker
          :add-time="addTime"
        ></custom-timepicker>
      </template>
    </div>
    <div class="form-group">
      <label class="col-sm-2 control-label">교실목록</label>
      <div v-for="(room, i) in room_to_use_list" >
        <button
        class="btn btn-default"
        v-bind:value="room.room_id" 
        :key="i"
        disabled
        >{{room.room_number}}({{room.name}})</button>
        <button 
        type="button" 
        class="btn btn-danger" 
        @click="deleteRoom(i)"
        v-if="mod!='GET'"
        >-</button>
      </div>
      <div v-if="mod!='GET'">
        <select class="form-control" v-model="room_index">
          <option v-for="(room, i) in room_results" v-bind:value="i" :key="i">
            {{ room.name }}
          </option>
        </select>
        <button 
          type="button" 
          class="btn btn-primary" 
          @click="addRoom($event)"
          v-if="mod!='GET'"
        >+</button>
      </div>
    </div>
    
    <label class="col-sm-2 control-label">학과</label>
    <div v-if="mod=='GET'" class="col-sm-10">
      <p class="form-control-static">{{ reservation.department_name }}</p>
    </div>
    <select v-else class="form-control" v-model="reservation.department_id" @change="chageDepartment">
      <option v-for="(department, i) in department_results" v-bind:value="department.department_id" :key="i">
        {{ department.name }}
      </option>
    </select>
    
    <label class="col-sm-2 control-label">스터디</label>
    <div v-if="mod=='GET'" class="col-sm-10">
      <p class="form-control-static">{{ reservation.study_group_name }}</p>
    </div>
    <select v-else class="form-control" v-model="reservation.study_group_id">
      <option v-for="(study_group, i) in study_group_results" v-bind:value="study_group.study_group_id" :key="i">
        {{ study_group.name }}
      </option>
    </select>

    <label class="col-sm-2 control-label">대표명</label>
    <div>
      <input type="text" class="form-control" v-model="reservation.representative_name" :disabled="mod == 'GET'">
    </div>
    <label class="col-sm-2 control-label">대표번호</label>
    <div>
      <input type="text" class="form-control" v-model="reservation.representative_phone" :disabled="mod == 'GET'">
    </div>
    
    <label class="col-sm-2 control-label">학생수</label>
    <div>
      <input type="text" class="form-control" v-model="reservation.student_count" :disabled="mod == 'GET'">
    </div>
    <label class="col-sm-2 control-label">비학생수</label>
    <div>
      <input type="text" class="form-control" v-model="reservation.non_student_count" :disabled="mod == 'GET'">
    </div>

    <div class="form-group" v-if="mod!='POST'">
      <label class="col-sm-2 control-label">최근 수정일</label>
      <div>
        <p class="form-control-static">{{reservation.datetime_last_updated}}</p>
      </div>
    </div>
    <div class="form-group" v-if="mod!='POST'">
      <label class="col-sm-2 control-label">생성일</label>
      <div>
        <p class="form-control-static">{{reservation.datetime_created}}</p>
      </div>
    </div>
    <div class="btn-group" role="group">

      <button 
        type="button" 
        class="btn btn-info"
        v-if="is_adminpage && mod=='GET'"
        @click="chageRsvStatus($event, reservation, global.REQ_RSV_STATUS)">요청</button> 
      <button 
        type="button" 
        class="btn btn-success"
        v-if="is_adminpage && mod=='GET'"
        @click="chageRsvStatus($event, reservation, global.SUBMIT_RSV_STATUS)">승인</button> 
      <button 
        type="button" 
        class="btn btn-danger"
        v-if="is_adminpage && mod=='GET'"
        @click="chageRsvStatus($event, reservation, global.CANCEL_RSV_STATUS)">취소</button> 

      <br />

      <div v-if="is_adminpage && is_admin==1">
        <button type="button" class="btn btn-warning" v-if="mod=='GET'" @click="setMod('PUT', $event)">수정</button>
      </div>

      <button 
      type="button" 
      class="btn btn-danger" 
      v-if="mod=='GET' && (is_adminpage || (reservation.is_mine == 1 && reservation.rsv_status == global.REQ_RSV_STATUS))"
      @click="deleteRsv($event, reservation)">
      삭제
      </button>
      <button 
      type="button" 
      class="btn btn-warning" 
      v-if="!is_adminpage && reservation.is_mine == 1 && reservation.rsv_status == global.SUBMIT_RSV_STATUS"
      @click="cancelRsv($event, reservation)">
      예약 취소
      </button>

      <button type="submit" class="btn btn-primary" v-if="mod!='GET'">제출</button>
    </div>
  </form>
</script>

<% include ../component/timepicker %>
<script>
  Vue.component('reservation-input', {
    template: '#input-template',
    props: {
      is_adminpage: Boolean,
      mod: String,
      is_admin: Number,
      building_id: Number,
      reservation: Object,
      rsv_status_results: Array,
      room_rsv_category_results: Array,
      department_results: Array,
    },
    data: function () {
      return {
        room_rsv_time_list: [],
        room_to_use_list: [],

        study_group_results: [],
        room_results: [],
        room_index: null,
      }
    }, 
    methods: {
      addTime: function(start_time, end_time) {
        var room_rsv_time_list = this.room_rsv_time_list;
        var flag = false;
        for (var i = 0; i < room_rsv_time_list.length; i++) {
          
        }
        // 정렬..
        if (flag) {
          alert('겹치는 시간을 확인해주세요');
        } else {
          this.room_rsv_time_list.push({
            room_rsv_id: reservation.room_rsv_id,
            start_time: start_time,
            end_time: end_time,
          })
        }
      },

      deleteRsvTime: function(index) {
        this.room_rsv_time_list.splice(index, 1)
      },
      deleteRoom: function(index) {
        this.room_to_use_list.splice(index, 1)
      },
      addRoom: function() {
        var room = this.room_results[this.room_index];
        for (var i = 0; i < this.room_to_use_list.length; i++) {
          if (this.room_to_use_list[i].room_id == room.room_id) {
            alert('이미 추가된 강의실입니다');
            return;
          }
        }
        this.room_to_use_list.push(room);
      },

      deleteRsv: function(e, reservation) {
        if (e) {
          e.preventDefault();
        }
        var url = '/api/room_rsv/' + reservation.room_rsv_id;
        var __this;
        global.ajax({
          url: url,
          type: 'DELETE',
        },
        function (data, status) {
          alert(data.message);
          if (__this.is_adminpage) {
            location.href='/admin/reservation/lookup?page=1'
          } else {
            if (__this.building_id) {
              location.href='/reservation/lookup/' + __this.building_id +'?page=1&is_mine=1'
            } else {
              location.href='/'
            }
          }
        },
        function (message, status, data) {
          alert(message);
        });
      },
      cancelRsv: function(e, reservation) {
        if (e) {
          e.preventDefault();
        }
        var url = '/api/room_rsv/cancel/' + reservation.room_rsv_id;
        global.ajax({
          url: url,
          type: 'PUT',
        },
        function (data, status) {
          alert(data.message);
        },
        function (message, status, data) {
          alert(message);
        });
      },
      chageRsvStatus: function(e, reservation, rsv_status) {
        if (e) {
          e.preventDefault();
        }
        var url = '/api/room_rsv/status/' + reservation.room_rsv_id;
        global.ajax({
          url: url,
          type: 'PUT',
          data: {
            rsv_status: rsv_status,
          },
        },
        function (data, status) {
          alert(data.message);
          location.reload();
        },
        function (message, status, data) {
          alert(message);
        });
      },
      setMod: function(mod, e) {
        if (e) {
          e.preventDefault();
        }
        if (mod == 'PUT') {
          this.getStudyGroupResults()
        }
        this.mod = mod;
      },
      onSubmitForm: function(e) {
        e.preventDefault();
        var __this = this;
        var mod = this.mod;
        let need_location_href = mod == 'POST' ? true : false;
        var url = '/api/study_group' + (mod == 'PUT' ? '/'+ this.reservation.study_group_id : '');
        global.ajax({
          url: url,
          type: mod,
          data: this.group,
        },
        function (data, status) {
          alert(data.message);
          if (need_location_href) {
            location.href='/study_group/lookup?page=1'
          } else {
            __this.setMod('GET');
          }
        },
        function (message, status, data) {
          alert(message);
        });
      },
      classRsvStatus: function(rsv_status) {
        return {
          'bg-info': rsv_status == global.REQ_RSV_STATUS,
          'bg-danger': rsv_status == global.CANCEL_RSV_STATUS,
          'bg-warning': rsv_status == global.CANCEL_REQ_RSV_STATUS,
          'bg-success': rsv_status == global.SUBMIT_RSV_STATUS,
        }
      },
      chageDepartment: function() {
        this.reservation.study_group_id = null;
        this.getStudyGroupResults();
      },
      getStudyGroupResults: function() {
        var __this = this;
        global.ajax({
          url: '/api/study_group' + global.serializeQuery({
            department_id: this.reservation.department_id,
          }),
          type: 'GET',
        },
        function (data, status) {
          __this.study_group_results = data.results;
        },
        function (message, status, data) {
          alert(message);
        });
      },
      getRoomResults: function() {
        var __this = this;
        global.ajax({
          url: '/api/room' + global.serializeQuery({
            building_id: this.building_id,
          }),
          type: 'GET',
        },
        function (data, status) {
          __this.room_results = data.results;
        },
        function (message, status, data) {
          alert(message);
        });
      },
      getRoomRsvTime: function() {
        var __this = this;
        global.ajax({
          url: '/api/room_rsv_time/' + reservation.room_rsv_id,
          type: 'GET',
        },
        function (data, status) {
          __this.room_rsv_time_list = data.results;
        },
        function (message, status, data) {
          alert(message);
        });
      },
      getRoomToUse: function() {
        var __this = this;
        global.ajax({
          url: '/api/room_to_use/' + reservation.room_rsv_id,
          type: 'GET',
        },
        function (data, status) {
          __this.room_to_use_list = data.results;
        },
        function (message, status, data) {
          alert(message);
        });
      },
    },
    watch: {
      mod: function (newMod) {
        if (newMod != 'GET') {
          this.getRoomResults();
        }
      }
    },
    created: function() {
      this.getRoomRsvTime()
      this.getRoomToUse()
    }
  })
</script>